# 0822

### 任务 文件上传模块(进度90%)

今天完成了文件上传node与web端的多文件上传的队列控制

### 明日计划

再测试上传部分逻辑，整理npm代码跟API文档

### 问题

#### 1 大文件分片上传后，要继续上传分片需要排查的情况

昨天主要是因为在某个队列请求返回查看是否有需要上传的文件，有的话，该上传谁，这部分处理不好

文件的状态如下

将状态集中放在一个变量，便于管理（而不是`file.status = 'queued'`）

```
 export const Status = {
        INITED:     'inited',    // 初始状态
        QUEUED:     'queued',    // 已经进入队列, 等待上传
        UPLOADING:   'uploading',    // 上传中
        ERROR:      'error',    // 上传出错，可重试
        COMPLETE:   'complete',    // 上传完成。
        CANCELLED:  'cancelled',    // 上传取消。
        SUCCESS:     'success',
        INTERRUPT:  'interrupt',    // 上传中断，可续传。
    };
```

改正如下

```
//文件还没上传完的逻辑,
//第一种情况（1）如果该文件前面需要上传的文件数大于等于并发数，要让出队列
//第二种情况,如果自己有占其他的队列（即自身请求数超过1），有要下载的任务话，要让出队列
其他情况，就上传自己
```

#### 2 文件上传过程中，如果用户删掉了

因为自己是将请求都由最外面的上传进程队列管理，所以用户删掉了话，size会为9，则会进到小文件处理中

```
if(file.size <= 0){
    _that.cancel(file)
    handleError('文件的size不能为0', file.uid, fileList, _events);    
    return 
  }
```

这也是我的方案缺点，因为放在最外面处理请求，每次都要去判断这个是属于小文件还是大文件，判断是否开启了大文件通道，是否支持node端的处理文件

